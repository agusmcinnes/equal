<div class="transactions-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Transacciones</h1>
      <div class="filters-row">
        <div class="filter-group">
          <label>Tipo:</label>
          <app-custom-select
            [options]="typeOptions"
            [(ngModel)]="filterType"
            (selectionChange)="changeTypeFilter($event)"
            placeholder="Tipo"
          ></app-custom-select>
        </div>
        <div class="filter-group">
          <label>Moneda:</label>
          <app-custom-select
            [options]="currencyOptions"
            [(ngModel)]="filterCurrency"
            (selectionChange)="changeCurrencyFilter($event)"
            placeholder="Moneda"
          ></app-custom-select>
        </div>
      </div>
    </div>
    <button class="btn-primary" (click)="showForm()">
      <span class="material-icons">add</span>
      Nueva transacción
    </button>
  </div>

  <!-- Statistics Section -->
  <div class="statistics-section" *ngIf="!loading">
    <div class="stats-grid">
      <app-stat-card
        title="Total Ingresos"
        [value]="statistics?.total_income || 0"
        icon="trending_up"
        [currency]="statistics?.currency || 'ARS'"
        [loading]="statsLoading"
      ></app-stat-card>

      <app-stat-card
        title="Total Gastos"
        [value]="statistics?.total_expenses || 0"
        icon="trending_down"
        [currency]="statistics?.currency || 'ARS'"
        [loading]="statsLoading"
      ></app-stat-card>

      <app-stat-card
        title="Balance"
        [value]="statistics?.net_balance || 0"
        icon="account_balance_wallet"
        [currency]="statistics?.currency || 'ARS'"
        [loading]="statsLoading"
      ></app-stat-card>

      <app-stat-card
        title="Transacciones"
        [value]="statistics?.transaction_count || 0"
        icon="receipt_long"
        [loading]="statsLoading"
      ></app-stat-card>
    </div>

    <!-- Charts -->
    <div class="charts-grid" *ngIf="!statsLoading && statistics && (incomeByCategoryData.length > 0 || expensesByCategoryData.length > 0)">
      <div class="chart-card" *ngIf="incomeByCategoryData.length > 0">
        <h3>Distribución de Ingresos por Categoría</h3>
        <ngx-charts-pie-chart
          [results]="incomeByCategoryData"
          [scheme]="incomeCategoryColorScheme"
          [view]="[450, 450]"
          [labels]="true"
          [doughnut]="true"
          [legend]="false"
        >
        </ngx-charts-pie-chart>
      </div>

      <div class="chart-card" *ngIf="expensesByCategoryData.length > 0">
        <h3>Distribución de Gastos por Categoría</h3>
        <ngx-charts-pie-chart
          [results]="expensesByCategoryData"
          [scheme]="expenseCategoryColorScheme"
          [view]="[450, 450]"
          [labels]="true"
          [doughnut]="true"
          [legend]="false"
        >
        </ngx-charts-pie-chart>
      </div>
    </div>
  </div>

  <!-- Transactions List -->
  <div class="transactions-section">
    <div class="section-header">
      <h2>Historial</h2>
      <div class="sort-options">
        <button
          class="sort-btn"
          [class.active]="sort.field === 'date'"
          (click)="changeSort('date')"
        >
          Fecha
          <span class="material-icons" *ngIf="sort.field === 'date'">
            {{ sort.order === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
          </span>
        </button>
        <button
          class="sort-btn"
          [class.active]="sort.field === 'amount'"
          (click)="changeSort('amount')"
        >
          Monto
          <span class="material-icons" *ngIf="sort.field === 'amount'">
            {{ sort.order === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
          </span>
        </button>
      </div>
    </div>

    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Cargando transacciones...</p>
    </div>

    <app-empty-state
      *ngIf="!loading && transactions.length === 0"
      icon="receipt_long"
      title="No hay transacciones"
      description="Comienza a registrar tus ingresos y gastos para visualizar tus finanzas."
      actionLabel="Crear transacción"
      actionIcon="add"
      (action)="showForm()"
    ></app-empty-state>

    <div *ngIf="!loading && transactions.length > 0" class="transactions-list">
      <div *ngFor="let group of groupedTransactions" class="transaction-group">
        <h3 class="group-label">{{ group.label }}</h3>

        <div class="transaction-card" *ngFor="let tx of group.transactions">
          <div class="tx-left" [class.income]="tx.type === 'income'" [class.expense]="tx.type === 'expense'">
            <app-category-badge
              [name]="tx.category_name || 'Sin categoría'"
              [icon]="tx.category_icon || 'category'"
              [color]="tx.category_color || '#6b7280'"
              size="medium"
            ></app-category-badge>
          </div>

          <div class="tx-center">
            <div class="tx-description">
              {{ tx.description || 'Sin descripción' }}
            </div>
            <div class="tx-metadata">
              <span class="tx-date">
                <span class="material-icons">schedule</span>
                {{ tx.date | date: 'short' }}
              </span>
              <span class="tx-wallet" *ngIf="tx.wallet_name">
                <span class="material-icons">account_balance_wallet</span>
                {{ tx.wallet_name }}
              </span>
              <span class="tx-recurring" *ngIf="tx.is_recurring">
                <span class="material-icons">event_repeat</span>
                Recurrente
              </span>
            </div>
          </div>

          <div class="tx-right">
            <div class="tx-amount" [class.income]="tx.type === 'income'" [class.expense]="tx.type === 'expense'">
              {{ tx.type === 'income' ? '+' : '-' }}{{ formatCurrency(tx.amount, tx.currency) }}
            </div>
            <div class="tx-actions">
              <button class="btn-icon" (click)="showForm(tx)" title="Editar">
                <span class="material-icons">edit</span>
              </button>
              <button class="btn-icon btn-danger" (click)="remove(tx.id)" title="Eliminar">
                <span class="material-icons">delete</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="!loading && totalPages > 1">
      <button
        class="pagination-btn"
        [disabled]="currentPage === 1"
        (click)="changePage(currentPage - 1)"
      >
        <span class="material-icons">chevron_left</span>
      </button>

      <span class="pagination-info">
        Página {{ currentPage }} de {{ totalPages }}
      </span>

      <button
        class="pagination-btn"
        [disabled]="currentPage === totalPages"
        (click)="changePage(currentPage + 1)"
      >
        <span class="material-icons">chevron_right</span>
      </button>
    </div>
  </div>

  <!-- Transaction Form Modal -->
  <div class="modal-overlay" *ngIf="formVisible" (click)="closeForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editing ? 'Editar' : 'Nueva' }} Transacción</h2>
        <button class="btn-close" (click)="closeForm()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <form class="transaction-form" (ngSubmit)="save()">
        <div class="form-row">
          <div class="form-group">
            <label>Fecha y Hora *</label>
            <app-datetime-picker
              [value]="model.date"
              (valueChange)="model.date = $event"
              placeholder="Seleccionar fecha y hora"
              [showTime]="true"
              [required]="true"
            ></app-datetime-picker>
            <span class="error" *ngIf="fieldErrors['date']">{{ fieldErrors['date'] }}</span>
          </div>

          <div class="form-group">
            <label>Tipo *</label>
            <app-custom-select
              [options]="transactionTypeOptions"
              [(ngModel)]="model.type"
              placeholder="Seleccionar tipo"
            ></app-custom-select>
            <span class="error" *ngIf="fieldErrors['type']">{{ fieldErrors['type'] }}</span>
          </div>
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <input
            type="text"
            [(ngModel)]="model.description"
            name="description"
            placeholder="Ej: Compra en supermercado"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Monto *</label>
            <input
              type="number"
              [(ngModel)]="model.amount"
              name="amount"
              min="0"
              step="0.01"
              placeholder="0.00"
              required
            />
            <span class="error" *ngIf="fieldErrors['amount']">{{ fieldErrors['amount'] }}</span>
          </div>

          <div class="form-group">
            <label>Moneda *</label>
            <app-custom-select
              [options]="formCurrencyOptions"
              [(ngModel)]="model.currency"
              placeholder="Seleccionar moneda"
            ></app-custom-select>
            <span class="error" *ngIf="fieldErrors['currency']">{{ fieldErrors['currency'] }}</span>
          </div>
        </div>

        <div class="form-group" *ngIf="model.currency === 'CRYPTO'">
          <label>Tipo de Cripto *</label>
          <app-custom-select
            [options]="cryptoTypeOptions"
            [(ngModel)]="model.crypto_type"
            placeholder="Seleccionar cripto"
          ></app-custom-select>
          <span class="error" *ngIf="fieldErrors['crypto_type']">{{ fieldErrors['crypto_type'] }}</span>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Categoría</label>
            <app-custom-select
              [options]="categorySelectOptions"
              [(ngModel)]="model.category_id"
              placeholder="Sin categoría"
              [loading]="!categoriesLoaded"
            ></app-custom-select>
          </div>

          <div class="form-group">
            <label>Billetera</label>
            <app-custom-select
              [options]="walletSelectOptions"
              [(ngModel)]="model.wallet_id"
              placeholder="Sin billetera"
              [loading]="!walletsLoaded"
            ></app-custom-select>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="closeForm()">
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="loading">
            {{ editing ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
