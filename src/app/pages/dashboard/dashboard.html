<div class="dashboard-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1>Dashboard</h1>
        <p class="header-subtitle">Resumen de tu situación financiera</p>
      </div>
    </div>
    <div class="header-actions">
      <div class="filter-group period-filter">
        <label>Período:</label>
        <app-custom-select
          [options]="periodOptions"
          [(ngModel)]="filterPeriod"
          (selectionChange)="changePeriodFilter($event)"
          placeholder="Período"
        ></app-custom-select>
      </div>
      <div class="filter-group currency-filter">
        <label>Moneda:</label>
        <app-custom-select
          [options]="currencyOptions"
          [(ngModel)]="filterCurrency"
          (selectionChange)="changeCurrencyFilter($event)"
          placeholder="Moneda"
        ></app-custom-select>
      </div>
      <button class="btn-primary" (click)="openQuickTransactionModal()">
        <span class="material-icons">add</span>
        Nueva transacción
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading" class="dashboard-content">
    <!-- Total Balance Section (All-time) -->
    <div class="total-balance-section" *ngIf="getTotalBalanceCurrencyKeys().length > 0">
      <div class="total-balance-header">
        <span class="material-icons">account_balance</span>
        <h2>Balance Total</h2>
        <span class="balance-subtitle">Histórico completo</span>
      </div>
      <div class="total-balance-grid">
        <div *ngFor="let curr of getTotalBalanceCurrencyKeys()" class="total-balance-item">
          <span class="balance-currency-label">{{ curr }}</span>
          <span class="balance-value" [class.positive]="totalBalanceByCurrency[curr].balance >= 0" [class.negative]="totalBalanceByCurrency[curr].balance < 0">
            {{ formatCurrency(totalBalanceByCurrency[curr].balance, curr) }}
          </span>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-section">
      <!-- Single Currency View -->
      <div *ngIf="filterCurrency !== 'all'" class="stats-grid">
        <app-stat-card
          title="Balance Neto"
          [value]="statistics?.net_balance || 0"
          icon="account_balance"
          [currency]="statistics?.currency || 'ARS'"
          [loading]="statsLoading"
        ></app-stat-card>

        <app-stat-card
          title="Total Ingresos"
          [value]="statistics?.total_income || 0"
          icon="trending_up"
          [currency]="statistics?.currency || 'ARS'"
          [loading]="statsLoading"
        ></app-stat-card>

        <app-stat-card
          title="Total Gastos"
          [value]="statistics?.total_expenses || 0"
          icon="trending_down"
          [currency]="statistics?.currency || 'ARS'"
          [loading]="statsLoading"
        ></app-stat-card>

        <app-stat-card
          title="Transacciones"
          [value]="statistics?.transaction_count || 0"
          icon="receipt_long"
          [loading]="statsLoading"
        ></app-stat-card>
      </div>

      <!-- Multi-Currency View -->
      <div *ngIf="filterCurrency === 'all'" class="multi-currency-stats">
        <div class="multi-stat-card">
          <div class="stat-header">
            <span class="material-icons">trending_up</span>
            <h3>Total Ingresos</h3>
          </div>
          <div class="stat-breakdown">
            <div *ngFor="let curr of getCurrencyKeys()" class="stat-row">
              <span class="currency-label">{{ curr }}</span>
              <span class="currency-value">{{ formatCurrency(multiCurrencyStats[curr].income, curr) }}</span>
            </div>
            <div *ngIf="getCurrencyKeys().length === 0" class="stat-empty">Sin ingresos</div>
          </div>
        </div>

        <div class="multi-stat-card">
          <div class="stat-header">
            <span class="material-icons">trending_down</span>
            <h3>Total Gastos</h3>
          </div>
          <div class="stat-breakdown">
            <div *ngFor="let curr of getCurrencyKeys()" class="stat-row">
              <span class="currency-label">{{ curr }}</span>
              <span class="currency-value">{{ formatCurrency(multiCurrencyStats[curr].expenses, curr) }}</span>
            </div>
            <div *ngIf="getCurrencyKeys().length === 0" class="stat-empty">Sin gastos</div>
          </div>
        </div>

        <div class="multi-stat-card">
          <div class="stat-header">
            <span class="material-icons">account_balance</span>
            <h3>Balance Neto</h3>
          </div>
          <div class="stat-breakdown">
            <div *ngFor="let curr of getCurrencyKeys()" class="stat-row">
              <span class="currency-label">{{ curr }}</span>
              <span class="currency-value" [class.positive]="multiCurrencyStats[curr].balance >= 0" [class.negative]="multiCurrencyStats[curr].balance < 0">
                {{ formatCurrency(multiCurrencyStats[curr].balance, curr) }}
              </span>
            </div>
            <div *ngIf="getCurrencyKeys().length === 0" class="stat-empty">Sin transacciones</div>
          </div>
        </div>

        <div class="multi-stat-card">
          <div class="stat-header">
            <span class="material-icons">receipt_long</span>
            <h3>Transacciones</h3>
          </div>
          <div class="stat-breakdown">
            <div class="stat-row single">
              <span class="currency-value large">{{ statistics?.transaction_count || 0 }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Distribution Section -->
    <div class="distribution-section" *ngIf="!distributionLoading && (incomeChartData.length > 0 || expenseChartData.length > 0)">
      <div class="section-header">
        <div class="section-title-group">
          <h2>Distribución por Categoría</h2>
          <span class="section-subtitle">{{ getPeriodLabel() }}</span>
        </div>
        <div class="distribution-currency-filter">
          <label>Moneda:</label>
          <app-custom-select
            [options]="distributionCurrencyOptions"
            [(ngModel)]="distributionCurrency"
            (selectionChange)="changeDistributionCurrency($event)"
            placeholder="Moneda"
          ></app-custom-select>
        </div>
      </div>

      <div class="distribution-grid">
        <!-- Income Distribution -->
        <div class="distribution-card income">
          <div class="distribution-card-header">
            <div class="distribution-type">
              <span class="material-icons">trending_up</span>
              <h3>Ingresos</h3>
            </div>
          </div>

          <div *ngIf="incomeChartData.length > 0; else noIncomeData" class="distribution-content">
            <div class="chart-area">
              <ngx-charts-pie-chart
                [results]="incomeChartData"
                [scheme]="incomeColorScheme"
                [labels]="false"
                [legend]="false"
                [doughnut]="true"
                [arcWidth]="0.4"
              >
              </ngx-charts-pie-chart>
            </div>

            <div class="category-list">
              <div
                *ngFor="let cat of getTopIncomeCategories(); let i = index"
                class="category-item"
                (click)="navigateToCategoryTransactions(cat.category_id)"
              >
                <div class="category-info">
                  <div class="category-icon-wrapper" [style.backgroundColor]="cat.category_color + '20'">
                    <span class="material-icons" [style.color]="cat.category_color">{{ cat.category_icon }}</span>
                  </div>
                  <div class="category-details">
                    <span class="category-name">{{ cat.category_name }}</span>
                    <span class="category-amount">{{ formatCurrency(cat.total_amount, getDistributionCurrency()) }}</span>
                  </div>
                </div>
                <div class="category-percentage">
                  <div class="percentage-bar">
                    <div class="percentage-fill" [style.width.%]="cat.percentage"></div>
                  </div>
                  <span class="percentage-value">{{ cat.percentage | number:'1.1-1' }}%</span>
                </div>
              </div>
            </div>
          </div>

          <ng-template #noIncomeData>
            <div class="empty-distribution">
              <span class="material-icons">trending_up</span>
              <p>Sin ingresos registrados</p>
            </div>
          </ng-template>
        </div>

        <!-- Expense Distribution -->
        <div class="distribution-card expense">
          <div class="distribution-card-header">
            <div class="distribution-type">
              <span class="material-icons">trending_down</span>
              <h3>Gastos</h3>
            </div>
          </div>

          <div *ngIf="expenseChartData.length > 0; else noExpenseData" class="distribution-content">
            <div class="chart-area">
              <ngx-charts-pie-chart
                [results]="expenseChartData"
                [scheme]="expenseColorScheme"
                [labels]="false"
                [legend]="false"
                [doughnut]="true"
                [arcWidth]="0.4"
              >
              </ngx-charts-pie-chart>
            </div>

            <div class="category-list">
              <div
                *ngFor="let cat of getTopExpenseCategories(); let i = index"
                class="category-item"
                (click)="navigateToCategoryTransactions(cat.category_id)"
              >
                <div class="category-info">
                  <div class="category-icon-wrapper" [style.backgroundColor]="cat.category_color + '20'">
                    <span class="material-icons" [style.color]="cat.category_color">{{ cat.category_icon }}</span>
                  </div>
                  <div class="category-details">
                    <span class="category-name">{{ cat.category_name }}</span>
                    <span class="category-amount">{{ formatCurrency(cat.total_amount, getDistributionCurrency()) }}</span>
                  </div>
                </div>
                <div class="category-percentage">
                  <div class="percentage-bar">
                    <div class="percentage-fill" [style.width.%]="cat.percentage"></div>
                  </div>
                  <span class="percentage-value">{{ cat.percentage | number:'1.1-1' }}%</span>
                </div>
              </div>
            </div>
          </div>

          <ng-template #noExpenseData>
            <div class="empty-distribution">
              <span class="material-icons">trending_down</span>
              <p>Sin gastos registrados</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Empty State for Charts -->
    <div *ngIf="!distributionLoading && incomeChartData.length === 0 && expenseChartData.length === 0" class="empty-charts-section">
      <div class="empty-charts">
        <app-empty-state
          title="Sin transacciones registradas"
          subtitle="Comienza a registrar transacciones para ver análisis y tendencias de tu dinero"
          icon="trending_up"
        ></app-empty-state>
        <div class="empty-actions">
          <button class="empty-btn" (click)="navigateToTransactions()">
            <span class="material-icons">add</span>
            Crear primera transacción
          </button>
        </div>
      </div>
    </div>

    <!-- Recent Transactions & Quick Actions & Wallet Summary -->
    <div class="bottom-section">
      <!-- Recent Transactions -->
      <div class="recent-transactions-card">
        <div class="card-header">
          <h3>Transacciones Recientes</h3>
          <button class="btn-link" (click)="navigateToTransactions()">
            Ver todas
            <span class="material-icons">arrow_forward</span>
          </button>
        </div>

        <div *ngIf="recentTransactions.length > 0; else noRecentTx" class="transactions-list">
          <div
            *ngFor="let tx of recentTransactions"
            class="transaction-card"
            [class.income]="tx.type === 'income'"
            [class.expense]="tx.type === 'expense'"
            [class.exchange]="tx.type === 'exchange'"
          >
            <div class="tx-type-indicator"></div>
            <div class="tx-content">
              <div class="tx-main">
                <div class="tx-category" *ngIf="tx.category_icon">
                  <app-category-badge
                    [name]="tx.category_name || 'Sin categoría'"
                    [color]="tx.category_color || '#9CA3AF'"
                    [icon]="tx.category_icon"
                    [size]="'small'"
                    [showLabel]="false"
                  ></app-category-badge>
                </div>
                <div class="tx-info">
                  <p class="tx-description tx-exchange" *ngIf="tx.type === 'exchange'; else dashboardRegularDesc">
                    <span class="tx-exchange-badge">
                      <span class="material-icons">currency_exchange</span>
                    </span>
                    <span class="tx-exchange-text">
                      <span class="tx-exchange-title">{{ getExchangeDisplay(tx).title }}</span>
                      <span class="tx-exchange-detail">{{ getExchangeDisplay(tx).detail }}</span>
                    </span>
                  </p>
                  <ng-template #dashboardRegularDesc>
                    <p class="tx-description">
                      {{ tx.description || tx.category_name || 'Sin categoría' }}
                    </p>
                  </ng-template>
                  <div class="tx-meta">
                    <span class="tx-date">{{ formatDate(tx.date) }}</span>
                    <span class="tx-separator">•</span>
                    <span class="tx-wallet">{{ tx.wallet_name || 'Sin billetera' }}</span>
                  </div>
                </div>
              </div>
              <div class="tx-amount-wrapper">
                <p
                  class="tx-amount"
                  [class.positive]="tx.type === 'income'"
                  [class.exchange]="tx.type === 'exchange'"
                >
                  {{ tx.type === 'income' ? '+' : tx.type === 'expense' ? '-' : '' }}${{ tx.amount | number: '1.2-2' }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <ng-template #noRecentTx>
          <app-empty-state
            title="Sin transacciones recientes"
            subtitle="Crea tu primera transacción para ver el historial aquí"
            icon="receipt_long"
          ></app-empty-state>
        </ng-template>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions-card">
        <h3>Acciones Rápidas</h3>
        <div class="actions-grid">
          <button class="action-btn" (click)="navigateToTransactions()">
            <span class="material-icons">add_circle</span>
            <span>Nueva Transacción</span>
          </button>
          <button class="action-btn" (click)="navigateToTransactions()">
            <span class="material-icons">swap_horiz</span>
            <span>Transacciones</span>
          </button>
          <button class="action-btn" (click)="navigateTo('categories')">
            <span class="material-icons">category</span>
            <span>Categorías</span>
          </button>
        </div>
      </div>

      <!-- Wallet Summary -->
      <div class="wallet-summary-card" *ngIf="wallets.length > 0">
        <h3>Tus Billeteras</h3>
        <div class="wallets-list">
          <div *ngFor="let wallet of wallets" class="wallet-item">
            <div class="wallet-icon">
              <span class="material-icons">account_balance_wallet</span>
            </div>
            <div class="wallet-info">
              <p class="wallet-name">{{ wallet.name }}</p>
              <p class="wallet-provider">{{ wallet.provider }}</p>
            </div>
            <div class="wallet-balance">
              <p class="balance-amount">${{ wallet.current_balance | number: '1.2-2' }}</p>
              <p class="balance-currency">{{ wallet.currency }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Transaction Modal -->
  <app-quick-transaction-modal
    [isOpen]="isQuickModalOpen"
    [categories]="categories"
    [wallets]="wallets"
    (close)="closeQuickTransactionModal()"
    (transactionCreated)="onQuickTransactionCreated()"
  ></app-quick-transaction-modal>
</div>
