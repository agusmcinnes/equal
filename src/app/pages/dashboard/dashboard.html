<div class="dashboard-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1>Dashboard</h1>
        <p class="header-subtitle">Resumen de tu situación financiera</p>
      </div>
    </div>
    <div class="header-actions">
      <div class="filter-group currency-filter">
        <label>Moneda:</label>
        <app-custom-select
          [options]="currencyOptions"
          [(ngModel)]="filterCurrency"
          (selectionChange)="changeCurrencyFilter($event)"
          placeholder="Moneda"
        ></app-custom-select>
      </div>
      <button class="btn-primary" (click)="navigateToTransactions()">
        <span class="material-icons">add</span>
        Nueva transacción
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading" class="dashboard-content">
    <!-- Summary Cards -->
    <div class="summary-section">
      <!-- Single Currency View -->
      <div *ngIf="filterCurrency !== 'all'" class="stats-grid">
        <app-stat-card
          title="Balance Total"
          [value]="totalWalletBalance"
          icon="account_balance_wallet"
          [currency]="statistics?.currency || 'ARS'"
          [loading]="statsLoading"
        ></app-stat-card>

        <app-stat-card
          title="Total Ingresos"
          [value]="statistics?.total_income || 0"
          icon="trending_up"
          [currency]="statistics?.currency || 'ARS'"
          [loading]="statsLoading"
        ></app-stat-card>

        <app-stat-card
          title="Total Gastos"
          [value]="statistics?.total_expenses || 0"
          icon="trending_down"
          [currency]="statistics?.currency || 'ARS'"
          [loading]="statsLoading"
        ></app-stat-card>

        <app-stat-card
          title="Transacciones"
          [value]="statistics?.transaction_count || 0"
          icon="receipt_long"
          [loading]="statsLoading"
        ></app-stat-card>
      </div>

      <!-- Multi-Currency View -->
      <div *ngIf="filterCurrency === 'all'" class="multi-currency-stats">
        <div class="multi-stat-card">
          <div class="stat-header">
            <span class="material-icons">trending_up</span>
            <h3>Total Ingresos</h3>
          </div>
          <div class="stat-breakdown">
            <div *ngFor="let curr of getCurrencyKeys()" class="stat-row">
              <span class="currency-label">{{ curr }}</span>
              <span class="currency-value">{{ formatCurrency(multiCurrencyStats[curr].income, curr) }}</span>
            </div>
            <div *ngIf="getCurrencyKeys().length === 0" class="stat-empty">Sin ingresos</div>
          </div>
        </div>

        <div class="multi-stat-card">
          <div class="stat-header">
            <span class="material-icons">trending_down</span>
            <h3>Total Gastos</h3>
          </div>
          <div class="stat-breakdown">
            <div *ngFor="let curr of getCurrencyKeys()" class="stat-row">
              <span class="currency-label">{{ curr }}</span>
              <span class="currency-value">{{ formatCurrency(multiCurrencyStats[curr].expenses, curr) }}</span>
            </div>
            <div *ngIf="getCurrencyKeys().length === 0" class="stat-empty">Sin gastos</div>
          </div>
        </div>

        <div class="multi-stat-card">
          <div class="stat-header">
            <span class="material-icons">account_balance_wallet</span>
            <h3>Balance</h3>
          </div>
          <div class="stat-breakdown">
            <div *ngFor="let curr of getWalletCurrencyKeys()" class="stat-row">
              <span class="currency-label">{{ curr }}</span>
              <span class="currency-value" [class.positive]="walletBalancesByCurrency[curr] >= 0" [class.negative]="walletBalancesByCurrency[curr] < 0">
                {{ formatCurrency(walletBalancesByCurrency[curr], curr) }}
              </span>
            </div>
            <div *ngIf="getWalletCurrencyKeys().length === 0" class="stat-empty">Sin billeteras</div>
          </div>
        </div>

        <div class="multi-stat-card">
          <div class="stat-header">
            <span class="material-icons">receipt_long</span>
            <h3>Transacciones</h3>
          </div>
          <div class="stat-breakdown">
            <div class="stat-row single">
              <span class="currency-value large">{{ statistics?.transaction_count || 0 }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section" *ngIf="!statsLoading && topExpensesChartData.length > 0">
      <!-- Top Expenses Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Top 5 Gastos por Categoría</h3>
          <span class="chart-info">Distribución actual</span>
        </div>
        <div class="chart-container-pie">
          <div class="chart-wrapper">
            <ngx-charts-pie-chart
              [results]="topExpensesChartData"
              [scheme]="expenseCategoryColorScheme"
              [labels]="true"
              [legend]="false"
              [doughnut]="false"
            >
            </ngx-charts-pie-chart>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State for Charts -->
    <div *ngIf="!statsLoading && topExpensesChartData.length === 0" class="empty-charts-section">
      <div class="empty-charts">
        <app-empty-state
          title="Sin transacciones registradas"
          subtitle="Comienza a registrar transacciones para ver análisis y tendencias de tu dinero"
          icon="trending_up"
        ></app-empty-state>
        <div class="empty-actions">
          <button class="empty-btn" (click)="navigateToTransactions()">
            <span class="material-icons">add</span>
            Crear primera transacción
          </button>
        </div>
      </div>
    </div>

    <!-- Recent Transactions & Quick Actions & Wallet Summary -->
    <div class="bottom-section">
      <!-- Recent Transactions -->
      <div class="recent-transactions-card">
        <div class="card-header">
          <h3>Transacciones Recientes</h3>
          <button class="btn-link" (click)="navigateToTransactions()">
            Ver todas
            <span class="material-icons">arrow_forward</span>
          </button>
        </div>

        <div *ngIf="recentTransactions.length > 0; else noRecentTx" class="transactions-list">
          <div
            *ngFor="let tx of recentTransactions"
            class="transaction-item"
            [class.income]="tx.type === 'income'"
            [class.expense]="tx.type === 'expense'"
          >
            <div class="tx-left">
              <div class="tx-category" *ngIf="tx.category_icon">
                <app-category-badge
                  [name]="tx.category_name || 'Sin categoría'"
                  [color]="tx.category_color || '#9CA3AF'"
                  [icon]="tx.category_icon"
                  [size]="'small'"
                ></app-category-badge>
              </div>
              <div class="tx-info">
                <p class="tx-description">{{ tx.description || tx.category_name || 'Sin categoría' }}</p>
                <p class="tx-date">{{ formatDate(tx.date) }}</p>
              </div>
            </div>

            <div class="tx-right">
              <p class="tx-amount" [class.positive]="tx.type === 'income'">
                {{ tx.type === 'income' ? '+' : '-' }}${{ tx.amount | number: '1.2-2' }}
              </p>
              <p class="tx-wallet">{{ tx.wallet_name || 'Sin billetera' }}</p>
            </div>
          </div>
        </div>

        <ng-template #noRecentTx>
          <app-empty-state
            title="Sin transacciones recientes"
            subtitle="Crea tu primera transacción para ver el historial aquí"
            icon="receipt_long"
          ></app-empty-state>
        </ng-template>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions-card">
        <h3>Acciones Rápidas</h3>
        <div class="actions-grid">
          <button class="action-btn" (click)="navigateToTransactions()">
            <span class="material-icons">add_circle</span>
            <span>Nueva Transacción</span>
          </button>
          <button class="action-btn" (click)="navigateToTransactions()">
            <span class="material-icons">swap_horiz</span>
            <span>Transacciones</span>
          </button>
          <button class="action-btn" (click)="navigateTo('categories')">
            <span class="material-icons">category</span>
            <span>Categorías</span>
          </button>
        </div>
      </div>

      <!-- Wallet Summary -->
      <div class="wallet-summary-card" *ngIf="wallets.length > 0">
        <h3>Tus Billeteras</h3>
        <div class="wallets-list">
          <div *ngFor="let wallet of wallets" class="wallet-item">
            <div class="wallet-icon">
              <span class="material-icons">account_balance_wallet</span>
            </div>
            <div class="wallet-info">
              <p class="wallet-name">{{ wallet.name }}</p>
              <p class="wallet-provider">{{ wallet.provider }}</p>
            </div>
            <div class="wallet-balance">
              <p class="balance-amount">${{ wallet.current_balance | number: '1.2-2' }}</p>
              <p class="balance-currency">{{ wallet.currency }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
