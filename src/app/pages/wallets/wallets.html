<div class="wallets-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1>Billeteras</h1>
        <p class="header-subtitle">Gestiona tus billeteras y monitorea tus balances</p>
      </div>
    </div>
    <button class="btn-primary" (click)="showWalletForm()" *ngIf="!formVisible">
      <span class="material-icons">add</span>
      Nueva billetera
    </button>
  </div>

  <!-- Summary Cards -->
  <div class="summary-section" *ngIf="(wallets.length > 0 || orphanedBalances.length > 0) && !formVisible">
    <div class="summary-card" *ngFor="let curr of currencies">
      <div class="summary-icon" [style.backgroundColor]="curr.color + '20'">
        <span class="material-icons" [style.color]="curr.color">account_balance_wallet</span>
      </div>
      <div class="summary-content">
        <div class="summary-label">{{ curr.name }}</div>
        <div class="summary-value">{{ formatCurrency(getTotalBalance()[curr.code], curr.code) }}</div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading && wallets.length === 0" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando billeteras...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading || wallets.length > 0" class="wallets-content">
    <!-- Wallet Form -->
    <div *ngIf="formVisible" class="form-card">
      <div class="form-header">
        <h2>{{ editing ? 'Editar Billetera' : 'Nueva Billetera' }}</h2>
        <button class="btn-close" (click)="closeWalletForm()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <form (ngSubmit)="saveWallet()" class="wallet-form">
        <!-- Name Field -->
        <div class="form-group">
          <label for="name">Nombre de la Billetera *</label>
          <input
            id="name"
            type="text"
            [(ngModel)]="model.name"
            name="name"
            placeholder="Ej: Mercado Pago, Efectivo"
            class="form-input"
            [class.error]="fieldErrors['name']"
          />
          <span class="error-message" *ngIf="fieldErrors['name']">
            {{ fieldErrors['name'] }}
          </span>
        </div>

        <!-- Provider Field -->
        <div class="form-group">
          <label for="provider">Proveedor *</label>
          <select
            id="provider"
            [(ngModel)]="model.provider"
            name="provider"
            class="form-select"
            [class.error]="fieldErrors['provider']"
          >
            <option *ngFor="let prov of availableProviders" [value]="prov.name">
              {{ prov.name }}
            </option>
          </select>
          <span class="error-message" *ngIf="fieldErrors['provider']">
            {{ fieldErrors['provider'] }}
          </span>
        </div>

        <!-- Currency Field -->
        <div class="form-group">
          <label for="currency">Moneda *</label>
          <select
            id="currency"
            [(ngModel)]="model.currency"
            name="currency"
            class="form-select"
            [class.error]="fieldErrors['currency']"
            [disabled]="!!editing"
          >
            <option *ngFor="let curr of currencies" [value]="curr.code">
              {{ curr.code }} - {{ curr.name }}
            </option>
          </select>
          <span class="error-message" *ngIf="fieldErrors['currency']">
            {{ fieldErrors['currency'] }}
          </span>
          <span class="info-message" *ngIf="editing">
            La moneda no puede modificarse después de crear la billetera
          </span>
        </div>

        <!-- Balance Field -->
        <div class="form-group">
          <label for="balance">Balance Inicial *</label>
          <input
            id="balance"
            type="number"
            [(ngModel)]="model.balance"
            name="balance"
            placeholder="0.00"
            class="form-input"
            [class.error]="fieldErrors['balance']"
            [disabled]="!!editing"
            step="0.01"
          />
          <span class="error-message" *ngIf="fieldErrors['balance']">
            {{ fieldErrors['balance'] }}
          </span>
          <span class="info-message" *ngIf="editing">
            El balance inicial no puede modificarse. El balance actual se calcula automáticamente.
          </span>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="btn-primary" [disabled]="loading">
            <span *ngIf="!loading">{{ editing ? 'Actualizar' : 'Crear' }}</span>
            <span *ngIf="loading" class="spinner-small"></span>
          </button>
          <button type="button" class="btn-secondary" (click)="closeWalletForm()">
            Cancelar
          </button>
        </div>
      </form>
    </div>

    <!-- Filter Tabs -->
    <div *ngIf="!formVisible && wallets.length > 0" class="filter-tabs">
      <button
        class="filter-tab"
        [class.active]="filterCurrency === 'all'"
        (click)="filterBy('all')"
      >
        Todas ({{ getWalletCountByCurrency('all') }})
      </button>
      <button
        class="filter-tab"
        [class.active]="filterCurrency === 'ARS'"
        (click)="filterBy('ARS')"
      >
        ARS ({{ getWalletCountByCurrency('ARS') }})
      </button>
      <button
        class="filter-tab"
        [class.active]="filterCurrency === 'USD'"
        (click)="filterBy('USD')"
      >
        USD ({{ getWalletCountByCurrency('USD') }})
      </button>
      <button
        class="filter-tab"
        [class.active]="filterCurrency === 'EUR'"
        (click)="filterBy('EUR')"
      >
        EUR ({{ getWalletCountByCurrency('EUR') }})
      </button>
      <button
        class="filter-tab"
        [class.active]="filterCurrency === 'CRYPTO'"
        (click)="filterBy('CRYPTO')"
      >
        CRYPTO ({{ getWalletCountByCurrency('CRYPTO') }})
      </button>
    </div>

    <!-- Wallets Grid -->
    <div *ngIf="!formVisible && (filteredWallets.length > 0 || hasOrphanedTransactions())" class="wallets-grid">
      <div *ngFor="let wallet of filteredWallets" class="wallet-card">
        <div class="card-header">
          <div class="wallet-icon" [style.backgroundColor]="getCurrencyInfo(wallet.currency!).color + '20'">
            <span class="material-icons" [style.color]="getCurrencyInfo(wallet.currency!).color">
              {{ getProviderIcon(wallet.provider || 'Otro') }}
            </span>
          </div>
          <div class="wallet-info">
            <h3>{{ wallet.name }}</h3>
            <p class="wallet-provider">{{ wallet.provider }}</p>
          </div>
          <div class="wallet-currency">
            <span class="currency-badge" [style.backgroundColor]="getCurrencyInfo(wallet.currency!).color">
              {{ wallet.currency }}
            </span>
          </div>
        </div>

        <div class="card-body">
          <!-- Balance Section -->
          <div class="balance-section">
            <div class="balance-item">
              <span class="balance-label">Balance Actual</span>
              <span class="balance-value current">
                {{ formatCurrency(wallet.current_balance || 0, wallet.currency || 'ARS') }}
              </span>
            </div>
          </div>

          <!-- Transaction Info -->
          <div class="transaction-info" *ngIf="wallet.transaction_count && wallet.transaction_count > 0">
            <span class="material-icons">receipt_long</span>
            <span>{{ wallet.transaction_count }} transacción{{ wallet.transaction_count !== 1 ? 'es' : '' }}</span>
          </div>
        </div>

        <div class="card-actions">
          <button class="btn-icon" (click)="showWalletForm(wallet); $event.stopPropagation()" title="Editar">
            <span class="material-icons">edit</span>
            Editar
          </button>
          <button class="btn-icon" (click)="openReconcileModal(wallet); $event.stopPropagation()" title="Conciliar saldo">
            <span class="material-icons">compare_arrows</span>
            Conciliar
          </button>
          <button class="btn-icon delete" (click)="openDeleteModal(wallet); $event.stopPropagation()" title="Eliminar">
            <span class="material-icons">delete</span>
            Eliminar
          </button>
        </div>
      </div>

      <!-- "Sin billetera" cards for orphaned transactions -->
      <div *ngFor="let orphaned of getFilteredOrphanedBalances()" class="wallet-card orphaned-card">
        <div class="card-header">
          <div class="wallet-icon orphaned-icon">
            <span class="material-icons" style="color: #9ca3af;">
              credit_card_off
            </span>
          </div>
          <div class="wallet-info">
            <h3>Sin billetera</h3>
            <p class="wallet-provider">Transacciones sin asignar</p>
          </div>
          <div class="wallet-currency">
            <span class="currency-badge" [style.backgroundColor]="getCurrencyInfo(orphaned.currency).color" style="opacity: 0.6;">
              {{ orphaned.currency }}
            </span>
          </div>
        </div>

        <div class="card-body">
          <div class="balance-section">
            <div class="balance-item">
              <span class="balance-label">Balance</span>
              <span class="balance-value current" [class.negative-balance]="orphaned.balance < 0">
                {{ formatCurrency(orphaned.balance, orphaned.currency) }}
              </span>
            </div>
          </div>
          <div class="transaction-info">
            <span class="material-icons">receipt_long</span>
            <span>{{ orphaned.count }} transacción{{ orphaned.count !== 1 ? 'es' : '' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!formVisible && filteredWallets.length === 0 && wallets.length > 0" class="empty-state-section">
      <app-empty-state
        title="Sin billeteras en este filtro"
        subtitle="No hay billeteras con la moneda seleccionada"
        icon="account_balance_wallet"
      ></app-empty-state>
      <button class="btn-secondary" (click)="filterBy('all')">
        Ver todas las billeteras
      </button>
    </div>

    <div *ngIf="!formVisible && wallets.length === 0" class="empty-state-section">
      <app-empty-state
        title="Sin billeteras"
        subtitle="Crea tu primera billetera para comenzar a gestionar tus finanzas"
        icon="account_balance_wallet"
      ></app-empty-state>
      <button class="btn-primary" (click)="showWalletForm()">
        <span class="material-icons">add</span>
        Crear primera billetera
      </button>
    </div>
  </div>

  <!-- Delete Wallet Modal -->
  <div class="modal-overlay" *ngIf="deleteModalVisible" (click)="closeDeleteModal()">
    <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <span class="material-icons" style="color: #dc2626;">delete</span>
          <div>
            <h2>Eliminar billetera</h2>
            <p>{{ deleteModalWalletName }}</p>
          </div>
        </div>
        <button class="btn-close" (click)="closeDeleteModal()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body">
        <p class="modal-info delete-warning">
          ¿Está seguro de que desea eliminar esta billetera? Esta acción no se puede deshacer.
        </p>
        <div class="delete-detail" *ngIf="deleteModalTxCount > 0">
          <span class="material-icons">warning</span>
          <span>Se eliminarán también <strong>{{ deleteModalTxCount }} transacción{{ deleteModalTxCount !== 1 ? 'es' : '' }}</strong> asociada{{ deleteModalTxCount !== 1 ? 's' : '' }}.</span>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeDeleteModal()" [disabled]="deleteModalLoading">Cancelar</button>
        <button class="btn-danger" (click)="confirmDeleteWallet()" [disabled]="deleteModalLoading">
          <span *ngIf="!deleteModalLoading">
            <span class="material-icons">delete</span>
            Eliminar
          </span>
          <span *ngIf="deleteModalLoading" class="spinner-small"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Reconciliation Modal -->
  <div class="modal-overlay" *ngIf="reconcileVisible" (click)="closeReconcileModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <span class="material-icons">account_balance_wallet</span>
          <div>
            <h2>Conciliar saldo</h2>
            <p>{{ reconcileWallet?.name }} · {{ reconcileWallet?.currency }}</p>
          </div>
        </div>
        <button class="btn-close" (click)="closeReconcileModal()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body">
        <p class="modal-info">
          No modificamos tu historial. Crearemos un ajuste automático para que el saldo contable iguale el saldo real.
        </p>

        <div class="reconcile-grid">
          <div class="reconcile-item">
            <span class="reconcile-label">Saldo contable actual</span>
            <span class="reconcile-value">
              {{ formatCurrency(reconcileCurrentBalance, reconcileWallet?.currency || 'ARS') }}
            </span>
          </div>

          <div class="reconcile-item">
            <label class="reconcile-label" for="realBalance">Saldo real</label>
            <input
              id="realBalance"
              type="number"
              class="form-input"
              [(ngModel)]="reconcileRealBalance"
              (ngModelChange)="onReconcileRealBalanceChange($event)"
              name="realBalance"
              step="0.01"
              placeholder="0.00"
            />
          </div>

          <div class="reconcile-item diff" [class.positive]="reconcileDifference > 0" [class.negative]="reconcileDifference < 0">
            <span class="reconcile-label">Diferencia</span>
            <span class="reconcile-value">
              {{ formatCurrency(reconcileDifference, reconcileWallet?.currency || 'ARS') }}
            </span>
            <span class="reconcile-hint" *ngIf="reconcileDifference > 0">Se creará un ingreso de ajuste</span>
            <span class="reconcile-hint" *ngIf="reconcileDifference < 0">Se creará un gasto de ajuste</span>
            <span class="reconcile-hint" *ngIf="isZeroDifference">No se requiere ajuste</span>
          </div>
        </div>

        <div class="reconcile-preview">
          <div class="preview-title">
            <span class="material-icons">receipt_long</span>
            <span>Movimiento de ajuste</span>
          </div>
          <div class="preview-row">
            <span>Tipo</span>
            <strong>{{ reconcileType === 'income' ? 'Ingreso' : 'Gasto' }}</strong>
          </div>
          <div class="preview-row">
            <span>Categoría</span>
            <strong>Ajustes</strong>
          </div>
          <div class="preview-row">
            <span>Origen</span>
            <strong>Conciliación de billetera</strong>
          </div>
          <div class="preview-row">
            <span>Monto</span>
            <strong>{{ formatCurrency(Math.abs(reconcileDifference), reconcileWallet?.currency || 'ARS') }}</strong>
          </div>
          <div class="preview-row">
            <span>Fecha</span>
            <strong>Hoy</strong>
          </div>
        </div>

        <div class="error-message" *ngIf="reconcileError">{{ reconcileError }}</div>
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeReconcileModal()">Cancelar</button>
        <button class="btn-primary" [disabled]="!reconcileCanConfirm" (click)="confirmReconciliation()">
          <span *ngIf="!reconcileLoading">Crear ajuste</span>
          <span *ngIf="reconcileLoading" class="spinner-small"></span>
        </button>
      </div>
    </div>
  </div>
</div>
