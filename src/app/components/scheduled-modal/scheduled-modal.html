<div class="modal-overlay" *ngIf="isOpen" (click)="onClose()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <h2 class="modal-title">{{ titleText }}</h2>
      <button class="close-btn" type="button" (click)="onClose()" title="Cerrar">
        <i class="material-icons">close</i>
      </button>
    </div>

    <!-- Body -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="modal-body">
      <!-- Error message -->
      <div class="error-message" *ngIf="errorMessage">
        <i class="material-icons">error</i>
        <span>{{ errorMessage }}</span>
      </div>

      <!-- Description -->
      <div class="form-group">
        <label for="description">Descripción *</label>
        <input
          id="description"
          type="text"
          formControlName="description"
          placeholder="Ej: Pago de renta"
          class="form-control"
        />
        <span class="error-text" *ngIf="form.get('description')?.hasError('required') && form.get('description')?.touched">
          La descripción es requerida
        </span>
        <span class="error-text" *ngIf="form.get('description')?.hasError('minlength') && form.get('description')?.touched">
          Mínimo 3 caracteres
        </span>
      </div>

      <!-- Type selector -->
      <div class="form-row">
        <div class="form-group">
          <label for="type">Tipo *</label>
          <select id="type" formControlName="type" class="form-control">
            <option value="income">Ingreso</option>
            <option value="expense">Gasto</option>
          </select>
        </div>

        <!-- Amount -->
        <div class="form-group">
          <label for="amount">Monto *</label>
          <input
            id="amount"
            type="number"
            formControlName="amount"
            placeholder="0.00"
            step="0.01"
            min="0"
            class="form-control"
          />
          <span class="error-text" *ngIf="form.get('amount')?.hasError('required') && form.get('amount')?.touched">
            El monto es requerido
          </span>
        </div>
      </div>

      <!-- Currency -->
      <div class="form-group">
        <label for="currency">Moneda *</label>
        <select id="currency" formControlName="currency" class="form-control">
          <option value="ARS">ARS (Pesos)</option>
          <option value="USD">USD (Dólares)</option>
          <option value="EUR">EUR (Euros)</option>
          <option value="CRYPTO">CRYPTO (Criptomonedas)</option>
        </select>
      </div>

      <!-- Category -->
      <div class="form-group">
        <label for="category_id">Categoría *</label>
        <select id="category_id" formControlName="category_id" class="form-control">
          <option [ngValue]="null">Seleccionar categoría</option>
          <option *ngFor="let cat of getFilteredCategories()" [ngValue]="cat.id">
            {{ cat.name }}
          </option>
        </select>
        <span class="error-text" *ngIf="form.get('category_id')?.hasError('required') && form.get('category_id')?.touched">
          La categoría es requerida
        </span>
      </div>

      <!-- Wallet -->
      <div class="form-group">
        <label for="wallet_id">Billetera</label>
        <select id="wallet_id" formControlName="wallet_id" class="form-control" [disabled]="!hasWalletsForCurrency()">
          <option [ngValue]="null">Sin billetera</option>
          <option *ngFor="let wallet of getFilteredWallets()" [ngValue]="wallet.id">
            {{ wallet.name }} ({{ wallet.provider }})
          </option>
        </select>
        <span class="help-text" *ngIf="!hasWalletsForCurrency()">
          <i class="material-icons">info</i>
          No hay billeteras disponibles para {{ form.get('currency')?.value }}. Puedes crear una desde la página de Billeteras.
        </span>
      </div>

      <!-- Schedule section -->
      <div class="form-section-title">
        <i class="material-icons">schedule</i>
        <span>Programación</span>
      </div>

      <!-- Frequency -->
      <div class="form-group">
        <label for="frequency">Frecuencia *</label>
        <select id="frequency" formControlName="frequency" class="form-control">
          <option *ngFor="let freq of frequencyOptions" [value]="freq.value">
            {{ freq.label }}
          </option>
        </select>
      </div>

      <!-- Start date -->
      <div class="form-group">
        <label for="start_date">Fecha de inicio *</label>
        <app-datetime-picker
          [value]="startDateValue"
          (valueChange)="onStartDateChange($event)"
          placeholder="Seleccionar fecha y hora"
          [showTime]="true"
          [required]="true"
        ></app-datetime-picker>
        <span class="error-text" *ngIf="form.get('start_date')?.hasError('required') && form.get('start_date')?.touched">
          La fecha de inicio es requerida
        </span>
      </div>

      <!-- End date (optional) -->
      <div class="form-group">
        <label for="end_date">Fecha de finalización (opcional)</label>
        <app-datetime-picker
          [value]="endDateValue"
          (valueChange)="onEndDateChange($event)"
          placeholder="Seleccionar fecha y hora"
          [showTime]="true"
        ></app-datetime-picker>
        <span class="error-text" *ngIf="form.hasError('endDateBeforeStart') && form.get('end_date')?.touched">
          La fecha de finalización debe ser posterior a la fecha de inicio
        </span>
        <span class="help-text" *ngIf="!form.hasError('endDateBeforeStart')">
          Deja en blanco si no tiene fecha de finalización
        </span>
      </div>

      <!-- Info box -->
      <div class="info-box">
        <i class="material-icons">info</i>
        <span>Esta transacción se ejecutará automáticamente en la fecha especificada según su frecuencia</span>
      </div>
    </form>

    <!-- Footer -->
    <div class="modal-footer">
      <button type="button" class="btn btn-cancel" (click)="onClose()">
        <span>Cancelar</span>
      </button>
      <button 
        type="submit" 
        class="btn btn-primary"
        [disabled]="!isFormValid || isLoading"
        (click)="onSubmit()"
      >
        <i class="material-icons" *ngIf="isLoading">hourglass_empty</i>
        <span>{{ submitButtonText }}</span>
      </button>
    </div>
  </div>
</div>
